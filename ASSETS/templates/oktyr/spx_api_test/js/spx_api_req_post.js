// This is a generic BASIC command handler
// between SPX and the template. See other
// SPX templates for more advanced functionality
// such as Update() etc..

// GOAL:
/*

To generate several rundown files:
MedelFinal_D21_StartLista
MedelFinal_H21_StartLista
etc.

With DataField that has one dropdown:
field: "f_vald_runner",
        ftype: "dropdown",
        title: "Select Runner to Follow",
        value: "0",
        items: [ <Array> ]

And the <Array> should look like:
        items: [
              {
                text: "1 Anna Andersson",
                value: "1",
              },
              {
                text: "2",
                value: "Bridget Johnson",
              },
            ]

The values should be retrieved from
FOR MOCKTEST: from ASSETS\templates\oktyr\sm2025medeldist\startList_14items_5fields.json
We will not try to read/fetch files from any other location, like DATAROOT!!!

FOR REAL PRODUCTION: from API response of GET REQ 'get list of all runners for class = XX in competition = YY'
*/

//
// Helper functions
//-----------------------------------------------------------------

function isEmptyJson(data) {
  // Check for null or undefined
  if (data == null) {
    // == operator covers both null and undefined!
    return true;
  }

  // If it's an array, check its length
  if (Array.isArray(data)) {
    return data.length === 0;
  }

  // If it's an object (but not an array), check its keys
  if (typeof data === "object") {
    return Object.keys(data).length === 0;
  }

  // If it's a plain object (not array, not null)
  if (typeof data === "object" && data.constructor === Object) {
    return Object.keys(data).length === 0;
  }

  // For any other type (string, number, etc.), return false or adjust as needed
  return false;
}

function getJsonSize(data) {
  if (Array.isArray(data)) {
    // For arrays, return the number of elements
    return data.length;
  } else if (data !== null && typeof data === "object") {
    // For objects, return the number of top-level keys
    return Object.keys(data).length;
  }
  // For other types (string, number, etc.), return 0
  return 0;
}

//
// MOCKTEST: Get test data from json file
//

fetch("startList_14items.json") // NOTE: This has title 'StartNumber and field 'f3' has been removed!
  //fetch("startList_12items.json") // NOTE: This has 'number' as ftype for f0!
  //fetch('startList_30items.json')  // NOTE: This has 'textfield' for f0 !!!

  .then((response) => {
    if (!response.ok) {
      console.log(`HTTP error! status: ${response.status}`);
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json(); // Parse JSON data
  })
  // Once fetched, the data remains in memory for the lifetime of the webpage
  .then((data) => {
    console.log("Size of DATA: ", getJsonSize(data));
    console.log("======  DATA AFTER FETCH:");
    console.log(data);

    //FIXME: Cache JSON data in sessionStorage OR in localStorage OR in IndexedDB???
    jsonRunnerInfoDataGlob = data;

    //TODO: Override with hard coded test data here?

    // Now use the jsonRunnerInfoDataGlob for lower thirds with runner info by getRunnerData()
  })
  .catch((error) => {
    console.error("Error fetching JSON data:", error);
  });

console.log("FINISHED with fetching JSON data");
// SLUT VERSION SOM FUNKADE

//
// SPX API REQ
//

/*
  https://spxgc.tawk.help/article/help-api
*/

// Define the values for your POST payload:
const projectName = "SPXAPITEST2"; // Avoid unusual characters!
const fileName = "myRundownFile22"; // Can both leave or include .json extension!
const content = {
  // content must be an object
  comment: "Playlist generated by OK Tyr via SPX API Endpoint",
  // Ensure you include a 'templates' array that is not empty.
  templates: [
    {
      // FIXME: can I set the template used for sending the POST req???
      relpath: "templates/myBaseTemplate.html", // Required for each template - TODO: Must this template exist or is it generated?
      DataFields: [
        // Populate with the required fields (must be non-empty)
        {
          field: "comment",
          ftype: "textfield",
          title: "Nickname of this item on the rundown",
          value: "[ NR NAMN KLUBB STARTTID ]",
        },
        {
          ftype: "instruction",
          value:
            "You can leave any field empty, except the start number (bib). This is a generic overlay with a Default theme.",
        },
        {
          field: "f0",
          ftype: "textfield",
          title: "Bib Number of Runner to Follow",
          value: "999",
        },
        {
          field: "f1",
          ftype: "caption",
          title: "Fullname",
          value: "FirstName LastName",
        },
        // Additional DataFields if needed
        {
          field: "f99",
          ftype: "filelist",
          title: "Visual theme",
          assetfolder: "./css/themes/",
          extension: "css",
          value: "./css/themes/Default.css",
        },
      ],
      // Provide default values for other expected properties
      playserver: "OVERLAY",
      playchannel: "1",
      playlayer: "5",
      webplayout: "5",
      out: "manual",
      dataformat: "json",
      uicolor: "3",
      // These may be overridden later by the API if needed.
      description: "Default description for First Template",
    },
  ],
};

/*
// Stringified JSON
{
    "project": "myProjectName",
    "file": "newRundown.json",
    "content": {
        "comment": "Playlist generated by MyApp",
        "templates": [
            {
                "description": "First template",
                "playserver": "OVERLAY",
                "etc": "..."
            },
            {
                "description": "Second template",
                "playserver": "OVERLAY",
                "etc": "..."
            }
        ]
    }
}
*/

// Make the POST request to /rundown/json

const url = "http://192.168.50.62:5656/api/v1/rundown/json";

// NOTE: If you’re running your client-side code on the same server as SPX‑GC,
// the relative URL /rundown/json should suffice.
//fetch("/rundown/json", {
fetch(url, {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    // TODO: If your API key is passed in a header, include it here, e.g.:
    // 'x-api-key': 'your-api-key'
  },
  body: JSON.stringify({
    project: projectName,
    file: fileName,
    content: content,
  }),
})
  .then((response) => {
    if (!response.ok) {
      // Handle non-200 HTTP responses
      throw new Error("Network response was not OK");
    }
    return response.json();
  })
  .then((data) => {
    console.log("Success:", data);
    // You can handle the returned info message here.
  })
  .catch((error) => {
    console.error("Error:", error);
    // You can display an error alert or a message in the UI.
  });
// end fetch
console.log("FINISHED with fetch of POST req to /rundown/json");

function update(data) {
  // Push data to template fields
  const jsonData = JSON.parse(data);
  for (var field in jsonData) {
    if (document.getElementById(field)) {
      let value = jsonData[field];
      if (value == "null" || value == "undefined") value = "";
      document.getElementById(field).innerHTML = value;
    }
  }
}

function play() {
  // Execute animation in
  runAnimationIN();
}

function stop() {
  // Execute animation out
  runAnimationOUT();
}
