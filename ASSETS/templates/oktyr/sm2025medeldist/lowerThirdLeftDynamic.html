<!DOCTYPE html>
<html lang="en">
  <!--
    (c) 2024 SPX Graphics
    Demo template for SPX. See SPXGCTemplateDefinition -object below for data field descriptions.
    Need custom templates? Get in touch! https://spx.graphics/contact

	PLEASE SEE THE LICENSE FILE FOR TERMS AND CONDITIONS.  

    ▸ spx.graphics | Copyright 2021-2024 SPX Graphics <https://spx.graphics>
    
    Version: ##-version-## / ##-comment-##
    Build: ##-builddate-## 

	----

    lowerThirdLeftDynamic for OK TYR SM 2025

    NAME_CLUB_LEFT_CORNER
    Description: A lower third in the bottom left corner,
    with data fields for NUMBER, NAME, CLUB.

    Extra Features:
    With dynamic update of data from API enpoint.

    Animation Lib:
    anime.js v3.2.0

	Changes:
    29.06.2022 Added FPS value check from SPX renderer
    24.08.2022 Fixed bug FPS value check (if not available)
    06.05.2024 Replaced GSAP with AnimeJS. Simplified source.
    08.04.2025 Changed theme to News.
    08.04.2025 Added number field as f0.
    21.04.2025 Renamed style tag from gfx to SPXgfx.
    28.04.2025 Removed box4 and text3 (field f3).
    28.04.2025 Changed to Williams stylesheet.
    28.04.2025 Using anime timeline (similar to SPX demo).
    28.04.2025 Added dropdown for selecting runner by bib nr.
-->

  <head>
    <meta charset="utf-8" />
    <title>LEFT CORNER</title>
    <!-- Next scripts use defer and are executed in order -->
    <script type="text/javascript" src="js/spx_interface.js" defer></script>
    <script type="text/javascript" src="js/lib/anime.min.js" defer></script>
    <link rel="stylesheet" type="text/css" href="css/oktyr_style.css" />
    <link
      rel="stylesheet"
      type="text/css"
      id="DynamicTheme"
      href="css/themes/News.css"
    />
    <style>
      /* För att animationen ska fungera – se till att .graphic initialt är dold */
      .graphic {
        /* FIXME: # or . ? */
        opacity: 0;
      }

      #box1 {
        font-size: 3vw;
        font-family: "BOLD";
        padding: 0.1em 0.5em;
      }
      /* MOVED TO oktyr_style.css as .metaData #details .second */
      /*
      #details {
        gap: 0;
        display: flex;
        flex-direction: row;
      }
      */
      #box2 {
        font-size: 2vw;
        font-family: "REGU";
        padding: 0.2em 0;
      }

      #vald_runner_bib {
        margin-right: 1em; /* Adjust space between number and name */
      }

      #vald_runner_name {
        margin-right: 1em; /* TODO?: Adjust space between number and name */
      }

      #g2 {
        padding: 0 0.8em;
      }
    </style>

    <script>
      // The code in the <head> is executed before the DOM is fully loaded.
      document.addEventListener("DOMContentLoaded", () => {
        console.log("!!!! DOM content loaded (html head)!!!! ");
      });

      let clipNone = "inset(0%   0% 0% 0%)";
      let clipEast = "inset(0% 100% 0% 0%)";
      let clipSout = "inset(0% 0% 100% 0%)";

      /**
       * The error "Failed to get element f_vald_klass by Id" indicates that the JavaScript code is unable to find an HTML element with the ID "f_vald_klass" in the current document. This typically happens when:
       *
       * 1. Element Doesn't Exist: The HTML element with the specified ID ("f_vald_klass") is not present in the DOM (Document Object Model) when the JavaScript code attempts to access it.
       * 2. Timing Issue: The JavaScript code runs before the HTML element is loaded and added to the DOM. This can occur if the script is placed in the <head> or loaded before the body of the document is fully parsed.
       */

      function runTemplateUpdate(runnerObj) {
        // MOVED TO getSelectedDataFromTemplate() since I tried to add code to do this input control check earlier. But it FAILED.
        /*
        getEl("vald_klass").innerHTML = htmlDecode(getEl("f_vald_klass").innerText);

        // TODO: Check that we have retrieved a valid runner from API
        let validRunnerFoundFromAPI = true;

        let validRunnerSelectedInUI = true;

        // If selected a bib from dropdown
        if (getEl("f_vald_runner_bib").innerText) {
          getEl("vald_runner_bib").innerHTML = htmlDecode(
            getEl("f_vald_runner_bib").innerText
          );

          // TDOD: Set name from local Storage? or from parameter?
          getEl("vald_runner_name").innerHTML =
            "SET RUNNER NAME FROM STORAGE OR PARAMETER!";
          // TODO: Set club name
          validRunnerSelectedInUI = true;
        } else {
          alert(
            "No runner selected! Trying to use runner id from input text field.\n Note that you may select a runner in dropdown\n."
          );

          // TODO: If not valid runner selected, then check if user has entered a bib number into input control?

          if (getEl("f0").innerText !== "") {
            getEl("vald_runner_bib").innerHTML = htmlDecode(getEl("f0").innerText);

            getEl("vald_runner_name").innerHTML =
              "SET RUNNER NAME FROM STORAGE OR PARAMETER!";

            // TODO: Set club name
            validRunnerSelectedInUI = true;
          } else {
            alert(
              "No runner selected! Please either select a runner in dropdown\n or write a valid runner id in input text field."
            );
            validRunnerSelectedInUI = false;
            return; // <----------- RETURN!
          }
        }

        if (!validRunnerFoundFromAPI && !validRunnerSelectedInUI) {
          return; // <----------- RETURN!
        }
        */

        getEl("vald_klass").innerHTML = runnerObj.class;

        // TODO: Set bib and name from API response
        getEl("vald_runner_bib").innerHTML = runnerObj.runners[0].bib;
        getEl("vald_runner_name").innerHTML = runnerObj.runners[0].name;
        // TODO: Set club name
        getEl("g2").innerHTML = runnerObj.runners[0].club;

        // Show all text-boxes
        getEl("box1").style.display = "flex";
        getEl("box2").style.display = "flex";

        // Hide empty ones
        if (getEl("vald_runner_bib").innerText == "") {
          getEl("vald_runner_bib").style.display = "none";
        }
        if (
          getEl("vald_runner_bib").innerText == "" &&
          getEl("vald_runner_name").innerText == ""
        ) {
          getEl("box1").style.display = "none";
        }
        if (getEl("g2").innerText == "") {
          getEl("box2").style.display = "none";
        }

        setTimeout(runAnimationIN, 50);
      } // runTemplateUpdate

      function runAnimationIN() {
        var timelineIn = anime
          .timeline({
            easing: "easeOutCubic",
            duration: 500,
          })

          .add(
            {
              targets: [".graphic"],
              opacity: [0, 1],
              duration: 50,
              easing: "linear",
            },
            0
          )
          // Animera in caption-bar (logo + caption-text)
          .add(
            {
              targets: [".caption-bar"],
              translateX: ["-100%", "0%"],
              opacity: [0, 1],
              duration: 500,
            },
            0
          )
          // Animera in box1 & box2 från undersidan med en staggered effekt
          .add(
            {
              targets: ["#box1", "#box2"],
              translateY: ["100%", "0%"],
              opacity: [0, 1],
              duration: 500,
              delay: anime.stagger(50),
            },
            50
          );
      } // runAnimationIN

      function runAnimationOUT() {
        var timelineOut = anime
          .timeline({
            easing: "easeInCubic",
            duration: 500,
          })

          .add(
            {
              targets: ["#box1", "#box2", ".caption-bar"],
              translateY: ["0%", "100%"],
              opacity: [1, 0],
              duration: 500,
              delay: anime.stagger(100),
            },
            0
          )
          .add(
            {
              targets: [".graphic"],
              opacity: [1, 0],
              duration: 300,
            },
            100
          );
      } // runAnimationOUT

      window.SPXGCTemplateDefinition = {
        description: "Namestrap left",
        playserver: "OVERLAY",
        playchannel: "1",
        playlayer: "5",
        webplayout: "5",
        out: "manual",
        dataformat: "json",
        uicolor: "3",
        DataFields: [
          {
            field: "comment",
            ftype: "textfield",
            title: "Nickname of this item on the rundown",
            value: "[ (RUBRIK) NR NAMN KLUBB ]",
          },
          {
            ftype: "instruction",
            value:
              "You can leave any field empty. This is a lower-left overlay with a News theme.",
          },
          {
            field: "f_rubrik",
            ftype: "textfield",
            title: "Caption",
            value: "SM 2025 Karlstad",
          },
          {
            field: "f_vald_klass",
            ftype: "dropdown",
            title: "Select Class",
            value: "D21",
            items: [
              {
                text: "D21",
                value: "D21",
              },
              {
                text: "H21",
                value: "H21",
              },
              {
                text: "D20",
                value: "D20",
              },
              {
                text: "H20",
                value: "H20",
              },
              {
                text: "D18",
                value: "D18",
              },
              {
                text: "H18",
                value: "H18",
              },
            ],
          },
          {
            field: "f_vald_runner_bib",
            ftype: "dropdown",
            title: "Select Runner",
            value: "0 - Default Test Runner",
            items: [
              {
                text: "1 - Firstname Lastname",
                value: "1",
              },
              {
                text: "2 - Firstname Lastname",
                value: "2",
              },
              {
                text: "3 - Firstname Lastname",
                value: "3",
              },
            ],
          },
          {
            field: "f0",
            ftype: "textfield",
            title: "Number",
            value: "9999",
          },
          {
            field: "f1",
            ftype: "caption",
            title: "Fullname",
            value: "",
          },
          {
            field: "f2",
            ftype: "caption",
            title: "Club",
            value: "",
          },
          /*
          {
            field: "f_update_from_api_btn",
            ftype: "button",
            title: "Update & Follow",
            descr: "Update live data for selected Runner",
            fcall: "window.updateFollowedRunner()",
          },
          */
        ],
      };
    </script>
  </head>

  <body class="lowerThirdLeft">
    <div class="container">
      <div class="graphic vertical">
        <!-- Caption bar med logo och caption text -->
        <div class="caption-bar">
          <div class="logo">
            <img src="images/sun_logo.png" alt="" />
          </div>
          <div class="caption-text">
            <span id="vald_klass">HD XX</span>
          </div>
        </div>
        <div class="data">
          <!-- MetaData: Box1 (f0 och f1) och Box2 (f2) -->
          <div class="metaData">
            <div class="first" id="box1">
              <!-- Span is inline, will appear on the same line -->
              <span id="vald_runner_bib">0</span>
              <span id="vald_runner_name">H B</span>
            </div>
            <div id="details">
              <div class="second" id="box2">
                <!-- Div is block-level, will start on its own line -->
                <div id="g2"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="hiddenSpxData" data-info="See spx_styles.css">
      <div data-info="Rubrik..........." id="f_rubrik"></div>
      <div data-info="Vald klass......." id="f_vald_klass">HD XX</div>
      <div data-info="Vald runner......" id="f_vald_runner_bib">0</div>
      <div data-info="StartNumber......" id="f0"></div>
      <div data-info="Fullname........." id="f1"></div>
      <div data-info="Club............." id="f2"></div>
    </div>

    <!-- TODO: Ensure that HTML content has loaded before the following script runs -->

    <script>
      //function getSelectedDataFromTemplate() {
      // FIXME: Remove? Is it really needed, if we just use PLAY as trigger for update()
      /*
      window.getSelectedDataFromTemplate = function () {
        let element = document.getElementById("f_vald_klass");
        console.log(element); //FIXME: null

        if (typeof element != "undefined" && element != null) {
          // NOTE: Use innerText to get the content of the div.
          selectedClass = element.innerText;
        } else {
          console.error("Failed to get element f_vald_klass by Id");
        }

        //getEl("vald_klass").innerHTML = htmlDecode(getEl("f_vald_klass").innerText);

        // If selected a bib from dropdown
        if (getEl("f_vald_runner_bib").innerText) {
          getEl("vald_runner_bib").innerHTML = htmlDecode(
            getEl("f_vald_runner_bib").innerText
          );
        } else {
          alert(
            "No runner selected! Trying to use runner id from input text field.\n Note that you may select a runner in dropdown\n."
          );

          // If not valid runner selected, then check if user has entered a bib number into input control?
          if (getEl("f0").innerText !== "") {
            // TODO: Check that it is a number!
            getEl("vald_runner_bib").innerHTML = htmlDecode(
              getEl("f0").innerText
            );

            validRunnerSelectedInUI = true;
          } else {
            alert(
              "No runner selected! Please either select a runner in dropdown\n or write a valid runner id in input text field."
            );
            validRunnerSelectedInUI = false;
            return; // <----------- RETURN!
          }
        }

        // Get the vald klass from dropdown
        // NOTE: The value property is only available for form elements
        // like <input>, <textarea>, or <select>.
        element = document.getElementById("f_vald_klass");
        console.log(element);

        if (typeof element != "undefined" && element != null) {
          // NOTE: Use innerText to get the content of the div.
          selectedClass = element.innerText;

          // Save persistently
          if (selectedClass) {
            localStorage.setItem("selectedClass", selectedClass);
            console.log("selectedClass saved: ", selectedClass);
          }
        }

        // First try to get the bib number from dropdown
        let elem_runner = document.getElementById("f_vald_runner");

        if (typeof elem_runner != "undefined" && elem_runner != null) {
          // NOTE: Use innerText to get the content of the div.
          selectedRunnerBib = elem_runner.innerText;

          // Save persistently
          if (selectedRunnerBib) {
            localStorage.setItem("selectedRunnerBib", selectedRunnerBib);
            console.log("selectedRunnerBib saved: ", selectedRunnerBib);
          } else {
            validRunnerSelectedInUI = false;
          }
        }
        if (!validRunnerSelectedInUI) {
          // Try to get the runner bib number from editable input textfield instead
          selectedRunnerBib = htmlDecode(getEl("f0").innerText);
          //alert(selectedRunnerBib);
          if (selectedRunnerBib) {
            localStorage.setItem("selectedRunnerBib", selectedRunnerBib);
            console.log("BibNr saved", selectedRunnerBib);
          } else {
            console.error(
              "Failed to get runner bib number from editor controls"
            );
            return; // <----------- RETURN!
          }
        }
        return;
      };
      */
    </script>
  </body>
</html>
